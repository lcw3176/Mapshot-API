<div th:fragment="common-scripts">
    <script crossorigin="anonymous"
            integrity="sha512-Hzlk8LOpeLtZLCTLvwaTlQo6iJKTEd/QRH8XgxB9QG7gXApOvOOOsmPYGneRWH2fcscI7Pb/UI6UTv56yfutXw=="
            referrerpolicy="no-referrer"
            src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.15.0/proj4-src.min.js"></script>


    <script type="text/javascript">
        const layerUrl = "https://4sltozpltpmcbqqv62cynw5lie0gqjrv.lambda-url.ap-northeast-2.on.aws/"

        const epsg4326 = 'EPSG:4326'
        const epsg5181 = 'EPSG:5181'
        const epsg5179 = 'EPSG:5179'
        const epsg3857 = 'EPSG:3857'

        proj4.defs(epsg3857, '+proj=merc +a=6378137 +b=6378137 +lat_ts=0 +lon_0=0 +x_0=0 +y_0=0 +k=1 +units=m +nadgrids=@null +wktext +no_defs +type=crs')
        proj4.defs(epsg5181, '+proj=tmerc +lat_0=38 +lon_0=127 +k=1 +x_0=200000 +y_0=500000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +type=crs')
        proj4.defs(epsg5179, '+proj=tmerc +lat_0=38 +lon_0=127.5 +k=0.9996 +x_0=1000000 +y_0=2000000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +type=crs')

        function checkIfAddLayers(layer) {
            const element = window.document.getElementById('checker_true')

            if (element && !this.isEmpty(layer)) {
                makeLayers(element, layer, epsg5181)
            }
        }

        function isEmpty(input) {
            return typeof input === 'undefined' ||
                input === null ||
                input === '' ||
                input === 'null' ||
                input.length === 0 ||
                (typeof input === 'object' && !Object.keys(input).length)
        }

        function loadImage(img, URL, retries = 2) {
            img.onerror = () => {
                if (retries > 0) {
                    loadImage(img, URL, retries - 1)
                }
            }
            img.src = URL
        }

        function makeLayers(element, layers, targetEpsg) {
            let neLat = element.getAttribute('neLat')
            let neLng = element.getAttribute('neLng')
            let swLat = element.getAttribute('swLat')
            let swLng = element.getAttribute('swLng')
            const neLngLat = [parseFloat(neLng), parseFloat(neLat)]
            const swLngLat = [parseFloat(swLng), parseFloat(swLat)]
            const topRightTransformed = proj4(epsg4326, targetEpsg, neLngLat)
            const bottomLeftTransformed = proj4(epsg4326, targetEpsg, swLngLat)

            let image = window.document.getElementById('layer')
            let url = layerUrl +
                '?layer=' + layers +
                '&crs=' + targetEpsg +
                '&height=' + 2000 +
                '&ymin=' + bottomLeftTransformed[1] +
                '&xmin=' + bottomLeftTransformed[0] +
                '&ymax=' + topRightTransformed[1] +
                '&xmax=' + topRightTransformed[0]

            loadImage(image, url)
        }
    </script>
</div>


